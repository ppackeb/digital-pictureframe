<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="webApp.css">     
  <link rel="icon" type="image/x-icon" href="../renderer/assets/images/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="../renderer/assets/images/favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Main</title>     
</head>

<body onload='initialize()'>
 <section class="bottom-container">
    <!-- First row -->
    <div class="button-row two-items">
      <input type="image" id="delete" name="delete" src="../renderer/assets/images/app delete.png" style="filter:grayscale(100%)" disabled onclick="PrepMessage('delete')">
      <input type="image" id="rotate" name="rotate" src="../renderer/assets/images/app rotate.png" style="filter:grayscale(100%)" disabled onclick="PrepMessage('rotate')">
    </div>

    <!-- Second row -->
    <div class="button-row two-items">
      <input type="image" id="openModalButton" name="openModalButton" src="../renderer/assets/images/slider100img.png" onclick="document.getElementById('slider-modalOverlay').style.display='block'">
      <input type="image" id="options" name="options" src="../renderer/assets/images/app options.png" onclick="location.href='/appOptions';">
    </div>

    <!-- Third row -->
    <div class="button-row three-items">
      <input type="image" id="zoom" name="zoom" src="../renderer/assets/images/app zoom.png" onclick="location.href='/appZoom';">
      <input type="image" id="currentPlaylist" name="currentPlaylist" src="../renderer/assets/images/app playlist.png" onclick="location.href = `/appCurrentPlaylist`">
      <input type="image" id="location" name="location" src="../renderer/assets/images/app location.png" onclick="PrepMessage('location')">
    </div>

    <!-- Fourth row style="gap: 10vw"-->
    <div class="button-row three-items" >
      <input type="image" id="back" name="back" src="../renderer/assets/images/app back.png" onclick="PrepMessage('back')">
      <input type="image" id="play_pause" name="play_pause" src="../renderer/assets/images/app pause.png" onclick="PrepMessage('play_pause')">
      <input type="image" id="forward" name="forward" src="../renderer/assets/images/app next.png" onclick="PrepMessage('next')">
    </div>
  </section>

  <section>
    <!-- Modal Overlay and Slider -->
    <div id="slider-modalOverlay" onclick="this.style.display='none'">
      <div class="slider-modalWindow" onclick="event.stopPropagation()">
        <input type="range" id="slider" min="0" max="1" step="0.01" value="0">
      </div>
    </div>

    <!-- Dynamic Slider Style -->
    <style id="dynamicSliderStyle"></style>
  </section>

<script type='text/javascript' src='appServer.js'></script>
<script src="../../common/customAlert.js"></script> 
<script>

var playpauseswitch = 1; //tracks play pause state 1 is playing 0 is paused
//var switchstate;


async function initialize(){  
  //needed async await to ensure the order of the messages
  await PrepMessage('GetMutePlayState');  
}


document.getElementById('openModalButton').addEventListener('click', function () {
  PrepMessage('GetMutePlayState');
  document.getElementById('slider-modalOverlay').style.display = 'block';
});

// Close the modal when clicking outside the modal window
document.getElementById('slider-modalOverlay').addEventListener('click', function (e) {
  if (e.target.id === 'slider-modalOverlay') { // Check if clicked directly on the overlay
    document.getElementById('slider-modalOverlay').style.display = 'none';
  }
});

// Update the event listener to use the debounced function
document.getElementById('slider').addEventListener('input', function() {
  var sliderValue = this.value;
  setSliderImage(sliderValue);      
  PrepMessage('volume');
});


/*
Prepares and sends a command to the server via the makeRequest function.
@param {string} payload - The command string to send.
@returns {Promise<any>} A promise that resolves with the processed response data.
.invoke/.handle is used for request-response pattern
.send/.on is used for fire-and-forget or one-way messages
*/
async function PrepMessage(payload) {
  let messagePayload = null;
  switch (payload) {
    case 'GetMutePlayState':
      messagePayload = { command: 'GetMutePlayState', data: "" };
    break;
    case 'next':
      messagePayload = { command: 'direction', data: 'next' };
    break;
    case 'back':
      messagePayload = { command: 'direction', data: 'back' };
    break;
    case 'play_pause':
      messagePayload = await play_pause();
    break;
    case 'rotate':
      messagePayload = { command: 'filectrl', data: 'rotate' };
    break;
    case 'delete':
      messagePayload = { command: 'filectrl', data: 'delete' };
    break;
    case 'location':
      messagePayload = { command: 'information', data: 'location' };
    break;
    case 'volume':      
      messagePayload = { command: 'volume', data: document.getElementById('slider').value };
    break;
    default:    
    return;
  }
  try {
    // Await the response from the new, async makeRequest function.
    const returnData = await makeRequest('/app_sendrequest', messagePayload);
    command = returnData.command;
    data = returnData.data;
    // Handle the response based on the command.
    switch(messagePayload.command){
      case 'GetMutePlayState':        
        if (data === null) return; // No ImageWindow available
        playpauseswitch = data.playstate;
        document.getElementById('slider').value = data.volume;
        setSliderImage(data.volume);
        play_pause();
      break;

      default:          
      break;
    }      
  } catch (error) {      
    //ShowAlert('Error in html POST. '+ error, false).then((result) => {  })    
  }

}


function setSliderImage(sliderValue){
  // Determine which image to use based on the slider value
  var imageUrl;
  if (sliderValue == 0) {
      imageUrl = '../renderer/assets/images/slider0img.png';
  } else if (sliderValue > 0 && sliderValue <= .4 ) {
      imageUrl = '../renderer/assets/images/slider25img.png';
  } else if (sliderValue > .4 && sliderValue <= .8 ) {
      imageUrl = '../renderer/assets/images/slider50img.png';
  } else if (sliderValue > .8) {
      imageUrl = '../renderer/assets/images/slider100img.png';
  }            
  
  var thumbStyle = 
  `#slider::-webkit-slider-thumb {
      background: url(${imageUrl}) no-repeat center center;
      background-size: contain;
      width: clamp(2rem, 3rem, 4rem);
      height: clamp(2rem, 3rem, 4rem);
  }`;           
  // Add or update the style tag in the head of the document
  var styleTag = document.getElementById('dynamicSliderStyle');
  if (!styleTag) {
      styleTag = document.createElement('style');
      styleTag.id = 'dynamicSliderStyle';
      document.head.appendChild(styleTag);
  }
  styleTag.textContent = thumbStyle; // Update the content of the style tag  
}

async function play_pause(){  
  if (playpauseswitch == 0){    
    messagePayload = { command: 'direction', data: 'pause' };      
    document.getElementById("rotate").disabled = false;
    document.getElementById("delete").disabled = false;
    document.getElementById("rotate").style = "height:clamp(1rem, 20vw, 5rem)";
    document.getElementById("delete").style = "height:clamp(1rem, 20vw, 5rem)";    
    document.getElementById("play_pause").src = '../renderer/assets/images/app play.png';    
    playpauseswitch = 1;
  }else{    
    messagePayload = { command: 'direction', data: 'play' };         
    document.getElementById("rotate").style = "height:clamp(1rem, 20vw, 5rem);filter:grayscale(100%)";
    document.getElementById("delete").style = "height:clamp(1rem, 20vw, 5rem);filter:grayscale(100%)";    
    document.getElementById("rotate").disabled = true;  
    document.getElementById("delete").disabled = true;  
    document.getElementById("play_pause").src = '../renderer/assets/images/app pause.png';           
    playpauseswitch = 0;
  }
  return messagePayload;

}


</script>
</body>
</html>