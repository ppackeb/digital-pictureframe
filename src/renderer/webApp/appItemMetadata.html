
<!DOCTYPE html>
<html lang="en">
  <head>    
    <link rel="stylesheet" href="webApp.css">     
    <link rel="icon" type="image/x-icon" href="../renderer/assets/images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../renderer/assets/images/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Item Information</title>    
</head>
  

<body onload='initialize()'>
  <header>
    <h3 id="titleText">Item Information</h3>  
  </header>
  
  <section class="metadata-entry">
    <label for="newComments">Comments</label>
    <textarea id="newComments" ></textarea>        
    <div class="metadata-hidden">
      <input type="checkbox" id="hiddenCheckbox" >
      <label for="hiddenCheckbox">Sensitive Item</label>    
    </div>
    <p>
      NOTE: Saved changes are immediately applied to the item file, but are not reflected in the currently displayed item until it is either refreshed nightly or manually via Configuration Settings.
    </p>
  </section>

  <section class="bottom-buttons">    
    <button id="accept" name="accept" onclick="SaveChanges()">Save</button>
    <button id="home" name="home" onclick="cancel()">Cancel</button>
  </section>     

   
<script type='text/javascript' src='appServer.js'></script>
<script src="../../common/customAlert.js"></script> 
<script>
    
  const hiddenCheckbox = document.getElementById('hiddenCheckbox');   
  const newComments = document.getElementById('newComments'); 
  const homebutton = document.getElementById('home');
  let ImageEXIFdata = null;
  let initialComments = "";
  let initialHidden = false;

  async function initialize(){  
      document.getElementById('accept').disabled = true;     
      document.getElementById('accept').style.filter = "grayscale(100%)";              
      ImageEXIFdata = await PrepMessage('AppGetCurrentDisplayImageData');      
      if (ImageEXIFdata != null) {            
        const isSupported = ['.jpeg', '.jpg', '.mp4'].some(ext => ImageEXIFdata.ImagePath.toLowerCase().endsWith(ext));    
        if (isSupported) {
          // Populate the fields with the current data
          newComments.value = ImageEXIFdata.dbEXIFImageComments; 
          hiddenCheckbox.checked = ImageEXIFdata.dbEXIFHiddenImages;

          // Store initial values
          initialComments = (ImageEXIFdata.dbEXIFImageComments || "").trim();
          initialHidden = !!ImageEXIFdata.dbEXIFHiddenImages;
          newComments.addEventListener('input', checkForChanges);
          hiddenCheckbox.addEventListener('change', checkForChanges);      
        } else {
          ShowAlert('This file type is not supported for info data editing.', false).then((result) => {                
            PrepMessage('AppUnpause');
            homebutton.click(); // Redirect to home if unsupported
          })
        }
      } else {
        ShowAlert('Display window is not open.', false).then((result) => {      
          PrepMessage('AppUnpause');
          homebutton.click(); // Redirect to home if no display window
        })
      }
  } 

  function cancel() {
    PrepMessage('AppUnpause');
    // Redirect to the options page
    location.href = '/appOptions';
  } 

  function checkForChanges() {     
    const acceptBtn = document.getElementById('accept');
    const currentComments = newComments.value.trim();
    const currentHidden = hiddenCheckbox.checked;

    if (currentComments !== initialComments || currentHidden !== initialHidden) {
      acceptBtn.disabled = false;
      acceptBtn.style.filter = "none";
    } else {
      acceptBtn.disabled = true;
      acceptBtn.style.filter = "grayscale(100%)";
    }
  }

  function SaveChanges() {
    ImageEXIFdata.dbEXIFImageComments = newComments.value.trim() === "" ? null : newComments.value.trim();    
    ImageEXIFdata.dbEXIFHiddenImages = hiddenCheckbox.checked;
    PrepMessage('AppSaveEXIFData'); // Call the function to save changes   
    PrepMessage('AppUnpause');   
    location.href = '/appOptions';
  }

  async function PrepMessage(payload){  
    messagePayload = null;
    switch (payload){
      case 'AppGetCurrentDisplayImageData':
        messagePayload = {command:"AppGetCurrentDisplayImageData", data:{closepage:{done:0}}};
      break;      
      case 'AppUnpause':
        messagePayload = {command:"AppGetCurrentDisplayImageData", data:{closepage:{done:1}}};
      break; 
      case 'AppSaveEXIFData':
        messagePayload = {command: "AppSaveEXIFData", data: ImageEXIFdata};
      break;
    }  
    try {
      // Await the response from the new, async makeRequest function.
      const returnData = await makeRequest('/app_sendrequest', messagePayload);
      command = returnData.command;
      data = returnData.data;
      // Handle the response based on the command.
      switch(messagePayload.command){
        case 'AppGetCurrentDisplayImageData':        
          if (data === null) return; // No ImageWindow available
          return data; // Return the image data          
        break;

        default:          
        break;
      }      
    } catch (error) {      
      //ShowAlert('Error in html POST. '+ error, false).then((result) => {  })    
    }    
  }


</script>
</body>
</html>
