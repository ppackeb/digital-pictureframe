<!DOCTYPE html>
<html>

<head>
  <style>
      /*scroll table*/
      table {
                border-collapse: collapse;
                width: 90%;
      }

      th, td {
          text-align: left;
          padding: 8px;
      }

      tr:nth-child(even){
        background-color: #f2f2f2;
      }

      #table-scroll {
            height:150px;
            overflow:auto;  
            margin-top:20px;
      }

      th {
        position: sticky;
        top: 0; /* required for the stickiness */
      }
      tr.grey th {
        background-color: white;
      }  
  </style>
  <link rel="icon" type="image/x-icon" href="/res/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
</head>

<body onload="loadbody()">
  
  <br>
  <select name ="playlist_name" id="playlist_name" style=" font-size:20px; width: 8em" ></select>
  <label for="baseDELAY" style = 'font-size:20px;'>Choose Playlist</label>
  <br>
  <select id="baseDELAY" style="font-size:20px; width: 8em"  name="baseDELAY" >
    <option value="1000">1 second</option>        
    <option value="2000">2 second</option>       
    <option value="5000">5 seconds</option>
    <option value="10000">10 seconds</option>
    <option value="15000">15 seconds</option>
    <option value="20000">20 seconds</option>
    <option value="30000">30 seconds</option>
  </select>
  <label for="preloadNUM" style="font-size:20px">Choose Image Delay</label>
  <br>
  <select id="preloadNUM" name="preloadNUM" style="font-size:20px; width: 8em" onchange ='prefetchcheck()' >
    <option value="1">1 </option>  
    <option value="5">5 </option>  
    <option value="10">10 </option>
    <option value="20">20 </option>
    <option value="30">30 </option>     
  </select>
  <label  for="prefetchNUM" style="font-size:20px;" >Images to Preload</label>
  <br> 
  <select id="prefetchNUM" name="prefetchNUM" style="width: 8em; font-size:20px" onchange ='prefetchcheck()' >
    <option value="1">1 </option>      
    <option value="5">5 </option>
    <option value="10">10 </option>        
  </select>
  <label for="prefetchNUM" style="font-size:20px" >Images Same Dir</label>   
  <br>
  <br>
  <h1 style="font-size:20px; font-weight: bold;" >Directories</h1>
  <div style="font-size:20px" id="table-scroll" style="height:10" >
    <table id="playlist_dir">
        <tr class="grey"></tr>
    </table>
  </div> 
  <br>
  <table>
    <tr>
    <td><center><input type=image id="home" name="home" src='home.png' style="height:80px" onclick="location.href='/';"></center></td>
    <td><center><input type=image id="delete" name="delete" src='app delete.png' style="height:80px" onclick="deletePlaylist()"></center></td>
    <td><center><input type=image id="accept" name="accept" src='app accept.png' style="height:80px" onclick="playlistselect()"></center>    </td>
  </tr>
  </table>

</body>
<script type='text/javascript' src='/webApp/appServer.js'></script>
<script>


// there is a startshow call in main.js to start the display.html.  in display_function (called by display.html) the g_selPLAYLIST variable
// is what is looked at for selected playlist.  Should just be able to update this variable, close display.html and then call startshow


var playlists;  // holds g_playlist data returned from serverside read in DBFunctions.js
var payloadJSON; // complete copy of the playlists.json file

function deletePlaylist(){  
  let payloadJSONout = '{"command":"DeletePlaylist", "data":""}';
  payloadJSONout = JSON.parse(payloadJSONout);  // create json object to populate

  payloadJSONout.data = document.getElementById('playlist_name').value;

  payloadJSONout = JSON.stringify(payloadJSONout); // create json string to send
  makeRequest('POST','/app_sendrequest', payloadJSONout, function (err, data) {  
    if (err) {
      // do nothing
    }else{
      loadbody();                      
    }      
  }); 
}


function prefetchcheck(){
  var preload = Number(document.getElementById('preloadNUM').value);
  var prefetch = document.getElementById('prefetchNUM').value;
  if (prefetch > preload){
    document.getElementById('prefetchNUM').value = preload;
  }
  if (prefetch < 0){
    document.getElementById('prefetchNUM').value = 1;
  }
  if (prefetch % 1 != 0){ // check to see if prefetch has a decimal
    document.getElementById('prefetchNUM').value = 1;
  }
}

function parseplaylist(selectedplaylist){
  const playlistDir = document.getElementById('playlist_dir');
  const playlistName = document.getElementById('playlist_name');
  playlistDir.innerHTML = '';
  playlistName.innerHTML = '';

  Object.keys(playlists).forEach(function(name){
    let remainingString = name.slice(9);  //remove 'playlist_'
    let new_name;
    if (remainingString.includes('_')){        
      new_name = remainingString.replace(/_/g, ','); 
      if (new_name.includes('$')){  
        new_name = new_name.replace('$', '!');
      }
    } else {
      new_name = remainingString;
    }
    const newOption = document.createElement('option');
    newOption.value = name;
    newOption.textContent = new_name;
    playlistName.appendChild(newOption);
  });

  playlistName.value = selectedplaylist; // set selected playlist

  Object.keys(playlists).forEach(function(name){
    if (name == selectedplaylist){
      playlists[name].forEach(function(data) {
        const newRow = document.createElement('tr');
        const newCell = document.createElement('td');
        newCell.textContent = data;
        newRow.appendChild(newCell);
        playlistDir.appendChild(newRow);
      });
    }
  });
}

// reload directory list based on playlist
document.getElementById('playlist_name').addEventListener('change', function(){
  const selectedValue = document.getElementById('playlist_name').value;
  parseplaylist(selectedValue);
});

function playlistselect(){
  let payloadJSONout = '{"command":"", "data":""}';  // create object to populate with data
  payloadJSONout = JSON.parse(payloadJSONout);  
  payloadJSONout.command = 'app_writeDB';    
  payloadJSON.prefetchNUM = document.getElementById('prefetchNUM').value;  
  let new_name_val = document.getElementById('playlist_name').selectedOptions[0].text; 

  // ensure playlist name is formatted correctly before storing in database
  if (new_name_val.includes(',')) {
    new_name_val = new_name_val.replace(/,/g, '_');        
    if (new_name_val.includes('!')){  // ! is a reserved char for a table name
      new_name_val = new_name_val.replace('!', '$');
    }
  }      
  new_name_val = 'playlist_'+new_name_val;
  
  payloadJSON.selPLAYLIST = new_name_val;
  payloadJSON.preloadNUM = document.getElementById('preloadNUM').value;
  payloadJSON.basedelay = document.getElementById('baseDELAY').value; 
  payloadJSONout.data = payloadJSON; 
  payloadJSONout = JSON.stringify(payloadJSONout);

  makeRequest('POST','/app_sendrequest', payloadJSONout, function (err, data) {  
    if (err) {
      // do nothing
    }else{
      location.href='/'; 
      //HTMLResponseData = data;  this section does not need return data;          
    }              
  }); 
}

function loadbody(){
  let payloadJSONout = '{"command":"readPlaylistDB", "data":null}'; 
  makeRequest('POST','/app_sendrequest', payloadJSONout, function (err, data) {
    if (err) {
      
    }  
    payloadJSON = data;           
    playlists = payloadJSON.playlists;      
    if (Object.keys(playlists).length == 1){ //only one playlist so disable delete button
      document.getElementById('delete').disabled = true;
      document.getElementById('delete').style.filter = 'grayscale(100%)';        
    }
    g_selPLAYLIST = payloadJSON.selplaylist;
    document.getElementById('baseDELAY').value = parseInt(payloadJSON.basedelay);
    document.getElementById('preloadNUM').value = parseInt(payloadJSON.preload);
    document.getElementById('prefetchNUM').value = payloadJSON.prefetch;            
    parseplaylist('playlist_'+g_selPLAYLIST);
  }); 
}

</script>

</html>
